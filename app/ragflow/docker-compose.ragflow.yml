version: '3.9'

services:
  # MySQL database for metadata storage
  mysql:
    image: mysql:8.0
    container_name: ragflow_mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-ragflow_root_password}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-ragflow}
      MYSQL_USER: ${MYSQL_USER:-ragflow}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-ragflow_password}
    volumes:
      - ./volumes/mysql:/var/lib/mysql
      - ./init-mysql.sql:/docker-entrypoint-initdb.d/init-mysql.sql
    command: [
      '--character-set-server=utf8mb4',
      '--collation-server=utf8mb4_unicode_ci',
      '--default-authentication-plugin=mysql_native_password'
    ]
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    networks:
      - ragflow_network

  # Redis for caching and queues
  redis:
    image: redis:7-alpine
    container_name: ragflow_redis
    restart: always
    volumes:
      - ./volumes/redis:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      timeout: 20s
      retries: 10
    networks:
      - ragflow_network

  # Milvus vector database for embeddings
  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    container_name: ragflow_etcd
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - ./volumes/etcd:/etcd-data
    command: >
      etcd -advertise-client-urls=http://127.0.0.1:2379
      -listen-client-urls=http://0.0.0.0:2379
      -initial-advertise-peer-urls=http://127.0.0.1:2380
      -listen-peer-urls=http://0.0.0.0:2380
      -initial-cluster-token=etcd-cluster
      -initial-cluster=etcd-cluster=http://127.0.0.1:2380
      -name=etcd-cluster
      -data-dir=/etcd-data
    networks:
      - ragflow_network

  minio:
    image: minio/minio:RELEASE.2023-09-04T19-57-37Z
    container_name: ragflow_minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-miniorootpassword}
    volumes:
      - ./volumes/minio:/data
    command: minio server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - ragflow_network

  milvus-standalone:
    image: milvusdb/milvus:v2.3.1
    container_name: ragflow_milvus
    command: ["/tini", "--", "/milvus", "run", "standalone"]
    environment:
      - ETCD_ENDPOINTS=etcd:2379
      - MINIO_ADDRESS=minio:9000
    volumes:
      - ./volumes/milvus:/var/lib/milvus
    depends_on:
      - etcd
      - minio
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - ragflow_network

  # RAGFlow application services
  ragflow-api:
    image: inbound7/ragflow:latest
    container_name: ragflow_api
    restart: always
    environment:
      - RAGFLOW_MYSQL_HOST=mysql
      - RAGFLOW_MYSQL_PORT=3306
      - RAGFLOW_MYSQL_USER=${MYSQL_USER:-ragflow}
      - RAGFLOW_MYSQL_PASSWORD=${MYSQL_PASSWORD:-ragflow_password}
      - RAGFLOW_MYSQL_DB=${MYSQL_DATABASE:-ragflow}
      - RAGFLOW_REDIS_URL=redis://redis:6379/0
      - RAGFLOW_MINIO_HOST=minio:9000
      - RAGFLOW_MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - RAGFLOW_MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-miniorootpassword}
      - RAGFLOW_MILVUS_HOST=milvus-standalone
      - RAGFLOW_MILVUS_PORT=19530
      - RAGFLOW_API_KEY=${RAGFLOW_API_KEY:-your_api_key_here}
    volumes:
      - ./volumes/uploads:/app/media
      - ./volumes/parsed:/app/parsed
      - ./volumes/models:/app/models
    ports:
      - "${RAGFLOW_API_PORT:-9380}:9380"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      milvus-standalone:
        condition: service_healthy
    networks:
      - ragflow_network

  ragflow-web:
    image: inbound7/ragflow:latest
    container_name: ragflow_web
    restart: always
    environment:
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:${RAGFLOW_API_PORT:-9380}/api
    ports:
      - "${RAGFLOW_WEB_PORT:-3000}:3000"
    depends_on:
      - ragflow-api
    networks:
      - ragflow_network

networks:
  ragflow_network:
    driver: bridge

volumes:
  mysql_data:
  redis_data:
  etcd_data:
  minio_data:
  milvus_data: